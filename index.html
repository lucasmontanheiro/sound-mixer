<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Sound Mixer | Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a; /* Slate 900 */
      color: #f8fafc;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .record-glow {
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.2);
    }

    .recording .record-glow {
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    input[type="range"] {
      -webkit-appearance: none;
      background: transparent;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: #334155;
      border-radius: 3px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: #f97316; /* Electric Orange */
      cursor: pointer;
      margin-top: -9px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      border: 2px solid #0f172a;
    }

    .vu-bar {
      transition: width 0.05s linear;
    }

    .track-card {
      min-width: 140px;
      transition: all 0.2s ease;
    }

    .track-card.active {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.1);
    }

    /* Hide scrollbar for track list */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="p-6 flex justify-between items-center border-b border-white/5 bg-slate-900/50">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
        <i data-lucide="waves" class="w-5 h-5 text-slate-900"></i>
      </div>
      <h1 class="text-xl font-bold tracking-tight">SoundMixer<span class="text-orange-500">PRO</span></h1>
    </div>
    <button id="settingsToggle" class="p-2 rounded-full hover:bg-white/5 transition-colors">
      <i data-lucide="sliders-horizontal" class="w-6 h-6 text-slate-400"></i>
    </button>
  </header>

  <main class="flex-grow flex flex-col p-4 md:p-8 max-w-2xl mx-auto w-full gap-8">
    
    <!-- Backing Track Selector -->
    <section class="space-y-4">
      <div class="flex justify-between items-end">
        <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Backing Track</h2>
        <label class="text-xs text-orange-500 font-medium cursor-pointer hover:underline">
          <input type="file" id="customFile" class="hidden" accept="audio/*" />
          + Upload Custom
        </label>
      </div>
      
      <div id="trackList" class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
        <!-- Tracks injected here -->
      </div>

      <div id="waveformContainer" class="h-16 w-full glass-panel rounded-xl overflow-hidden relative">
        <canvas id="waveformCanvas" class="w-full h-full opacity-50"></canvas>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
          <span id="trackNameDisplay" class="text-xs font-medium text-slate-300">Select a track to preview</span>
        </div>
      </div>
      <audio id="backing" crossorigin="anonymous" class="hidden"></audio>
    </section>

    <!-- Jam Zone -->
    <section class="flex-grow flex flex-col items-center justify-center py-8">
      <div class="relative">
        <button id="recordBtn" class="w-32 h-32 md:w-40 md:h-40 rounded-full bg-slate-800 border-4 border-slate-700 flex items-center justify-center transition-all active:scale-95 record-glow group">
          <div id="recordIcon" class="w-12 h-12 rounded-full bg-orange-500 group-hover:bg-orange-400 transition-colors"></div>
        </button>
        <div id="recordingTimer" class="absolute -bottom-8 left-1/2 -translate-x-1/2 font-mono text-sm text-slate-400 hidden">
          00:00:00
        </div>
      </div>
    </section>

    <!-- Mixer Console -->
    <section class="glass-panel p-6 rounded-3xl space-y-8">
      <!-- VU Meters (No-Squint) -->
      <div class="space-y-4">
        <div class="space-y-1">
          <div class="flex justify-between text-[10px] uppercase font-bold text-slate-500 mb-1">
            <span>Input Level</span>
            <span id="vuText">0.00</span>
          </div>
          <div class="h-3 w-full bg-slate-900 rounded-full overflow-hidden p-[2px]">
            <div id="vuBar" class="vu-bar h-full w-0 bg-gradient-to-r from-emerald-500 via-yellow-500 to-red-500 rounded-full"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Mic Level -->
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i data-lucide="mic" class="w-4 h-4 text-orange-500"></i>
              <span class="text-sm font-semibold">Microphone</span>
            </div>
            <span id="micLevelVal" class="text-xs font-mono text-slate-400">2.00</span>
          </div>
          <input id="micLevel" type="range" min="0" max="5" step="0.05" value="2.00" class="w-full" />
        </div>

        <!-- Backing Level -->
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i data-lucide="music" class="w-4 h-4 text-orange-500"></i>
              <span class="text-sm font-semibold">Backing</span>
            </div>
            <span id="backingLevelVal" class="text-xs font-mono text-slate-400">0.60</span>
          </div>
          <input id="backingLevel" type="range" min="0" max="2" step="0.01" value="0.60" class="w-full" />
        </div>
      </div>

      <!-- Mute Monitoring Toggle -->
      <div class="flex items-center justify-between pt-4 border-t border-white/5">
        <div class="flex items-center gap-2">
          <i data-lucide="headphones" class="w-4 h-4 text-slate-400"></i>
          <span class="text-sm text-slate-300 font-medium">Monitoring</span>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="muteMonitoring" type="checkbox" checked class="sr-only peer">
          <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
          <span class="ml-3 text-xs font-medium text-slate-400">Mute</span>
        </label>
      </div>
    </section>

    <!-- Results Modal Overlay -->
    <div id="resultModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md hidden animate-in fade-in duration-300">
      <div class="glass-panel w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl border-orange-500/20 flex flex-col items-center gap-6 scale-95 animate-in zoom-in-95 duration-300">
        <div class="w-20 h-20 bg-orange-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/20">
          <i data-lucide="check" class="w-10 h-10 text-slate-900"></i>
        </div>
        
        <div class="text-center space-y-1">
          <h3 class="text-2xl font-bold tracking-tight">Recording Ready</h3>
          <p class="text-slate-400 text-sm">Your masterpiece is ready to share.</p>
        </div>

        <div class="w-full space-y-4">
          <audio id="result" controls class="w-full h-10 brightness-90 contrast-125"></audio>
          
          <div class="grid grid-cols-2 gap-3 pt-2">
            <button id="closeModal" class="px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm font-bold uppercase tracking-wider transition-colors">
              Dismiss
            </button>
            <a id="downloadLink" download class="px-4 py-4 rounded-2xl bg-orange-500 hover:bg-orange-600 text-slate-900 text-sm font-bold uppercase tracking-wider text-center transition-colors flex items-center justify-center gap-2">
              <i data-lucide="share-2" class="w-4 h-4"></i>
              Share
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer Actions -->
  <footer class="p-6 pb-10 flex justify-center gap-6 border-t border-white/5 bg-slate-900/50">
    <button id="resetBtn" class="flex flex-col items-center gap-1 group">
      <div class="p-3 rounded-2xl bg-slate-800 group-hover:bg-slate-700 transition-colors">
        <i data-lucide="rotate-ccw" class="w-6 h-6 text-slate-400"></i>
      </div>
      <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Reset</span>
    </button>
    <button id="playbackBtn" class="flex flex-col items-center gap-1 group">
      <div class="p-3 rounded-2xl bg-slate-800 group-hover:bg-slate-700 transition-colors">
        <i data-lucide="play" class="w-6 h-6 text-slate-400"></i>
      </div>
      <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Listen</span>
    </button>
  </footer>

<script>
const TRACKS = [
  { 
    name: "Slow Blues in E", 
    url: "audio/slow_blues_backing_track_in_e.mp3",
    img: "image/slow_blues_backing_track_in_e.png"
  },
  { 
    name: "Jazz Swing (II V I)", 
    url: "audio/Backing Track _ II V I _ E major _ Jazz Swing.mp3",
    img: "image/Backing Track _ II V I _ E major _ Jazz Swing.png"
  },
  { 
    name: "Indie Folk", 
    url: "audio/Backing_Track_Indie_Folk_E_major.mp3",
    img: "image/Backing_Track_Indie_Folk_E_major.png"
  },
  { 
    name: "Neo-Soul Guitar", 
    url: "audio/Deep Lofi Neo-Soul Guitar Backing Track _ E Minor.mp3",
    img: "image/Deep Lofi Neo-Soul Guitar Backing Track _ E Minor.png"
  },
  {
    name: "Funky Hendrix (Am)",
    url: "audio/Funky Jimi Hendrix Jam  Guitar Backing Track (A Minor).mp3",
    img: "https://images.unsplash.com/photo-1510915361894-db8b60106cb1?auto=format&fit=crop&w=300&q=80"
  },
  {
    name: "Rock Pop (C Maj)",
    url: "audio/Rock Pop Backing Track C Major  70 BPM  Guitar Backing Track.mp3",
    img: "https://images.unsplash.com/photo-1493225255756-d9584f8606e9?auto=format&fit=crop&w=300&q=80"
  },
  {
    name: "Sad Minor Blues (Am)",
    url: "audio/Sad Minor Blues BACKING TRACK JAM  in A.mp3",
    img: "https://images.unsplash.com/photo-1514525253361-b83f859b73c0?auto=format&fit=crop&w=300&q=80"
  },
  {
    name: "Smooth Jazz (Em)",
    url: "audio/Soulful SMOOTH JAZZ Backing Track in E minor (Blues & Altered Scale Diagrams).mp3",
    img: "https://images.unsplash.com/photo-1511192336575-5a79af67a629?auto=format&fit=crop&w=300&q=80"
  }
];

// Initialize Lucide
lucide.createIcons();

const recordBtn = document.getElementById("recordBtn");
const recordIcon = document.getElementById("recordIcon");
const backingEl = document.getElementById("backing");
const resultEl = document.getElementById("result");
const downloadLink = document.getElementById("downloadLink");
const trackListEl = document.getElementById("trackList");
const trackNameDisplay = document.getElementById("trackNameDisplay");
const customFileInput = document.getElementById("customFile");

const micSlider = document.getElementById("micLevel");
const micVal = document.getElementById("micLevelVal");
const backingSlider = document.getElementById("backingLevel");
const backingVal = document.getElementById("backingLevelVal");

const vuBar = document.getElementById("vuBar");
const vuText = document.getElementById("vuText");
const muteToggle = document.getElementById("muteMonitoring");
const recordingTimer = document.getElementById("recordingTimer");

let currentTrackUrl = TRACKS[0].url;
let isRecording = false;
let startTime;
let timerInterval;

function formatTime(ms) {
  const seconds = Math.floor((ms / 1000) % 60);
  const minutes = Math.floor((ms / (1000 * 60)) % 60);
  const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function initTrackList() {
  TRACKS.forEach((track, index) => {
    const card = document.createElement("div");
    card.className = `track-card flex-shrink-0 w-32 h-32 rounded-2xl border-2 border-white/5 bg-cover bg-center relative cursor-pointer overflow-hidden ${index === 0 ? 'active' : ''}`;
    card.style.backgroundImage = `url('${track.img}')`;
    card.innerHTML = `
      <div class="absolute inset-0 bg-slate-900/40 group-hover:bg-slate-900/20 transition-colors"></div>
      <div class="absolute bottom-3 left-3 right-3">
        <p class="text-[10px] font-bold leading-tight drop-shadow-md text-white">${track.name}</p>
      </div>
    `;

    card.onclick = () => {
      document.querySelectorAll('.track-card').forEach(el => el.classList.remove('active'));
      card.classList.add('active');
      selectTrack(track.url, track.name);
    };
    trackListEl.appendChild(card);
  });
  selectTrack(currentTrackUrl, TRACKS[0].name);
}

function selectTrack(url, name) {
  currentTrackUrl = url;
  backingEl.src = url;
  trackNameDisplay.textContent = name;
  backingEl.load();
}

customFileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (file) {
    const url = URL.createObjectURL(file);
    selectTrack(url, file.name);
    // Add temporary card for custom track
    const card = document.createElement("div");
    card.className = `track-card flex-shrink-0 w-32 h-32 rounded-2xl border-2 border-orange-500 bg-slate-800 flex items-center justify-center p-4 text-center active`;
    card.innerHTML = `<p class="text-[10px] font-bold text-orange-500 uppercase">Custom: ${file.name}</p>`;
    document.querySelectorAll('.track-card').forEach(el => el.classList.remove('active'));
    trackListEl.prepend(card);
  }
};

let audioCtx, micStream;
let micGainNode, backingGainNode, mixBus, masterGain;
let mixDest, analyser, mediaRecorder;
let chunks = [];
let rafId;

function pickMimeType() {
  const types = ["audio/webm;codecs=opus", "audio/webm", "audio/ogg;codecs=opus"];
  return types.find(t => window.MediaRecorder?.isTypeSupported(t)) || "";
}

function updateSliderLabels() {
  micVal.textContent = Number(micSlider.value).toFixed(2);
  backingVal.textContent = Number(backingSlider.value).toFixed(2);
}

function startVuMeter() {
  const buf = new Float32Array(analyser.fftSize);
  const tick = () => {
    analyser.getFloatTimeDomainData(buf);
    let sum = 0;
    for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
    const rms = Math.sqrt(sum / buf.length);

    const level = Math.min(100, rms * 300); // Scale for visual impact
    vuBar.style.width = `${level}%`;
    vuText.textContent = (rms).toFixed(2);

    rafId = requestAnimationFrame(tick);
  };
  tick();
}

async function start() {
  isRecording = true;
  document.body.classList.add('recording');
  recordIcon.className = "w-10 h-10 rounded-lg bg-red-500 transition-all";
  recordingTimer.classList.remove('hidden');
  startTime = Date.now();
  timerInterval = setInterval(() => {
    recordingTimer.textContent = formatTime(Date.now() - startTime);
  }, 1000);

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  micStream = await navigator.mediaDevices.getUserMedia({
    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
  });

  const micSource = audioCtx.createMediaStreamSource(micStream);
  const backingSource = audioCtx.createMediaElementSource(backingEl);

  mixBus = audioCtx.createGain();
  micGainNode = audioCtx.createGain();
  backingGainNode = audioCtx.createGain();
  masterGain = audioCtx.createGain();
  
  const monitorGain = audioCtx.createGain();
  monitorGain.gain.value = muteToggle.checked ? 0 : 1;

  micGainNode.gain.value = Number(micSlider.value);
  backingGainNode.gain.value = Number(backingSlider.value);
  masterGain.gain.value = 0.9;

  micSource.connect(micGainNode);
  micGainNode.connect(mixBus);
  micGainNode.connect(monitorGain);
  
  backingSource.connect(backingGainNode).connect(mixBus);

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  mixDest = audioCtx.createMediaStreamDestination();
  mixBus.connect(mixDest);
  mixBus.connect(analyser); 
  
  backingGainNode.connect(audioCtx.destination);
  monitorGain.connect(audioCtx.destination);

  muteToggle.onchange = () => {
    monitorGain.gain.setTargetAtTime(muteToggle.checked ? 0 : 1, audioCtx.currentTime, 0.05);
  };

  micSlider.oninput = () => {
    micGainNode.gain.value = Number(micSlider.value);
    updateSliderLabels();
  };
  backingSlider.oninput = () => {
    backingGainNode.gain.value = Number(backingSlider.value);
    updateSliderLabels();
  };

  chunks = [];
  mediaRecorder = new MediaRecorder(mixDest.stream, { mimeType: pickMimeType() });

  mediaRecorder.ondataavailable = e => e.data.size && chunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
    const url = URL.createObjectURL(blob);
    resultEl.src = url;
    downloadLink.href = url;
    downloadLink.download = `Jam-${new Date().getTime()}.webm`;
    
    // Show Modal
    const modal = document.getElementById('resultModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lucide.createIcons(); // Refresh icons for the modal
  };

  mediaRecorder.start();
  backingEl.currentTime = 0;
  await backingEl.play();
  startVuMeter();
}

function stop() {
  isRecording = false;
  document.body.classList.remove('recording');
  recordIcon.className = "w-12 h-12 rounded-full bg-orange-500 transition-all";
  recordingTimer.classList.add('hidden');
  clearInterval(timerInterval);

  backingEl.pause();
  mediaRecorder?.stop();
  micStream?.getTracks().forEach(t => t.stop());
  audioCtx?.close();

  if (rafId) cancelAnimationFrame(rafId);
  vuBar.style.width = "0%";
  vuText.textContent = "0.00";
}

// Modal closure
document.getElementById('closeModal').onclick = () => {
  const modal = document.getElementById('resultModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
};

recordBtn.onclick = () => {
  if (!isRecording) {
    start().catch(err => {
      console.error(err);
      alert("Microphone access is required to record.");
      stop();
    });
  } else {
    stop();
  }
};

document.getElementById('resetBtn').onclick = () => {
  if (confirm("Clear current recording and start fresh?")) {
    stop();
    resultEl.src = "";
    document.getElementById('resultModal').classList.add('hidden');
    document.getElementById('resultModal').classList.remove('flex');
  }
};

document.getElementById('playbackBtn').onclick = () => {
  if (resultEl.src) {
    const modal = document.getElementById('resultModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    resultEl.play();
  } else {
    alert("Record something first!");
  }
};

// Initialize
initTrackList();
updateSliderLabels();
</script>
</body>
</html>
