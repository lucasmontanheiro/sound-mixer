<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mic + Backing Recorder</title>

  <style>
    :root {
      --bg: #ffffff;
      --text: #1a1a1a;
      --accent: #2563eb;
      --border: #e5e7eb;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      text-align: center;
      letter-spacing: -0.025em;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .controls-row {
      flex-direction: row;
      justify-content: center;
      gap: 12px;
    }

    button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    #startBtn {
      background-color: var(--accent);
      color: white;
    }

    #stopBtn {
      background-color: #ef4444;
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    label {
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .label-header {
      display: flex;
      justify-content: space-between;
      color: #6b7280;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      appearance: none;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    meter {
      width: 100%;
      height: 8px;
    }

    .hint {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
      line-height: 1.4;
    }

    audio {
      width: 100%;
      height: 40px;
    }

    .track-list {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
      scrollbar-width: none; /* Firefox */
    }

    .track-list::-webkit-scrollbar {
      display: none; /* Safari/Chrome */
    }

    .track-item {
      flex: 0 0 auto;
      padding: 12px 16px;
      background: #f3f4f6;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .track-item.active {
      background: #eff6ff;
      border-color: var(--accent);
      color: var(--accent);
    }

    .result-section {
      border-top: 1px solid var(--border);
      padding-top: 24px;
      margin-top: 8px;
    }

    #downloadLink {
      display: block;
      text-align: center;
      margin-top: 12px;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Recorder</h2>

    <div class="row">
      <label class="label-header">Select Backing Track</label>
      <div id="trackList" class="track-list">
        <!-- Tracks will be injected here -->
      </div>
      <audio id="backing" controls crossorigin="anonymous" style="margin-top: 12px;"></audio>
    </div>

    <div class="row controls-row">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="row">
      <label>
        <div class="label-header">
          <span>Mic level</span>
          <span id="micLevelVal">4.00</span>
        </div>
        <input id="micLevel" type="range" min="0" max="5" step="0.05" value="4.00" />
      </label>
    </div>

    <div class="row">
      <label>
        <div class="label-header">
          <span>Backing level</span>
          <span id="backingLevelVal">0.60</span>
        </div>
        <input id="backingLevel" type="range" min="0" max="2" step="0.01" value="0.6" />
      </label>
    </div>

    <div class="row">
      <label>
        <div class="label-header">
          <span>VU Meter</span>
          <span id="vuText">0.00</span>
        </div>
        <meter id="vu" min="0" max="1" low="0.6" high="0.85" optimum="0.4"></meter>
      </label>
    </div>

    <div class="result-section row">
      <label class="label-header">Recorded mix</label>
      <audio id="result" controls></audio>
      <a id="downloadLink" download style="display:none;">Download</a>
    </div>

    <div class="hint">
      Use headphones to avoid feedback.<br/>
      Keep VU below 0.85 for best quality.
    </div>
  </div>

<script>
const TRACKS = [
  { name: "Slow Blues in E", url: "https://raw.githubusercontent.com/lucasmontanheiro/static/main/sound-mixer/slow_blues_backing_track_in_e.mp3" },
  { name: "Jazz Swing", url: "https://raw.githubusercontent.com/lucasmontanheiro/static/main/sound-mixer/Backing Track _ II V I _ E major _ Jazz Swing.mp3" },
  { name: "Acoustic Folk", url: "https://raw.githubusercontent.com/lucasmontanheiro/static/main/sound-mixer/Backing Track E major (Indie Folk).mp3" },
  { name: "Rock Groove", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
  { name: "Lo-Fi Beats", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" }
];

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const backingEl = document.getElementById("backing");
const resultEl = document.getElementById("result");
const downloadLink = document.getElementById("downloadLink");
const trackListEl = document.getElementById("trackList");

const micSlider = document.getElementById("micLevel");
const micVal = document.getElementById("micLevelVal");
const backingSlider = document.getElementById("backingLevel");
const backingVal = document.getElementById("backingLevelVal");

const vuMeter = document.getElementById("vu");
const vuText = document.getElementById("vuText");

let currentTrackUrl = TRACKS[0].url;

function initTrackList() {
  TRACKS.forEach((track, index) => {
    const btn = document.createElement("div");
    btn.className = `track-item${index === 0 ? ' active' : ''}`;
    btn.textContent = track.name;
    btn.onclick = () => {
      document.querySelectorAll('.track-item').forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
      currentTrackUrl = track.url;
      backingEl.src = track.url;
      backingEl.load();
    };
    trackListEl.appendChild(btn);
  });
  backingEl.src = currentTrackUrl;
}

initTrackList();

let audioCtx, micStream;
let micGainNode, backingGainNode, mixBus, masterGain;
let mixDest, analyser, mediaRecorder;
let chunks = [];
let rafId;

function pickMimeType() {
  const types = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/ogg;codecs=opus",
    "audio/ogg"
  ];
  return types.find(t => window.MediaRecorder?.isTypeSupported(t)) || "";
}

function updateSliderLabels() {
  micVal.textContent = Number(micSlider.value).toFixed(2);
  backingVal.textContent = Number(backingSlider.value).toFixed(2);
}

function startVuMeter() {
  const buf = new Float32Array(analyser.fftSize);

  const tick = () => {
    analyser.getFloatTimeDomainData(buf);
    let sum = 0;
    for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
    const rms = Math.sqrt(sum / buf.length);

    const smooth = vuMeter.value * 0.8 + rms * 0.2;
    vuMeter.value = Math.min(1, smooth);
    vuText.textContent = vuMeter.value.toFixed(2);

    rafId = requestAnimationFrame(tick);
  };
  tick();
}

async function start() {
  startBtn.disabled = true;
  stopBtn.disabled = false;
  downloadLink.style.display = "none";
  resultEl.src = "";

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  micStream = await navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: false,
      noiseSuppression: false,
      autoGainControl: false
    }
  });

  const micSource = audioCtx.createMediaStreamSource(micStream);
  const backingSource = audioCtx.createMediaElementSource(backingEl);

  mixBus = audioCtx.createGain();
  micGainNode = audioCtx.createGain();
  backingGainNode = audioCtx.createGain();
  masterGain = audioCtx.createGain();

  micGainNode.gain.value = Number(micSlider.value);
  backingGainNode.gain.value = Number(backingSlider.value);
  masterGain.gain.value = 0.9;

  micSource.connect(micGainNode).connect(mixBus);
  backingSource.connect(backingGainNode).connect(mixBus);

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;

  mixDest = audioCtx.createMediaStreamDestination();

  mixBus.connect(masterGain);
  masterGain.connect(analyser);
  masterGain.connect(audioCtx.destination);
  masterGain.connect(mixDest);

  updateSliderLabels();

  micSlider.oninput = () => micGainNode.gain.value = Number(micSlider.value);
  backingSlider.oninput = () => backingGainNode.gain.value = Number(backingSlider.value);

  chunks = [];
  mediaRecorder = new MediaRecorder(mixDest.stream, { mimeType: pickMimeType() });

  mediaRecorder.ondataavailable = e => e.data.size && chunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
    const url = URL.createObjectURL(blob);
    resultEl.src = url;
    downloadLink.href = url;
    downloadLink.textContent = `Download (${blob.type})`;
    downloadLink.style.display = "inline-block";
  };

  mediaRecorder.start();
  backingEl.currentTime = 0;
  await backingEl.play();
  startVuMeter();
}

function stop() {
  stopBtn.disabled = true;
  startBtn.disabled = false;

  backingEl.pause();
  mediaRecorder?.stop();
  micStream?.getTracks().forEach(t => t.stop());
  audioCtx?.close();

  if (rafId) cancelAnimationFrame(rafId);
  vuMeter.value = 0;
  vuText.textContent = "0.00";
}

startBtn.onclick = () => start().catch(err => {
  alert(err.message || err);
  startBtn.disabled = false;
  stopBtn.disabled = true;
});
stopBtn.onclick = stop;
</script>
</body>
</html>
